{"data":{"site":{"siteMetadata":{"title":"Another Chris","author":"Chris Small"}},"markdownRemark":{"id":"37cd55dd-12f0-5b34-b533-abfe0ccca0c7","excerpt":"Warning: long boring how-to blog post … Letsencrypt.org  is a free SSL certificate service. As a certificate authority, it is (at the time of writing) trusted…","html":"<p><em>Warning: long boring how-to blog post</em>…</p>\n<p><a href=\"Letsencrypt.org\">Letsencrypt.org</a> is a free SSL certificate service. As a certificate authority, it is (at the time of writing) trusted by Chrome (desktop), IE10 and shortly Firefox. Currently it uses another provider for its authority chain, and the biggest restrictions are the SSL certificates are for public domains only and your certificates only last 3 months.</p>\n<p>It’s fairly easy to setup, you use a tool called cert-bot. This handles creating the private and public key for you, however it assumes you have your website running on is a single VM/server with a known IP address.</p>\n<p>This caused problems for me when running a site in a Docker container on Kubernetes, on Google Cloud, as it’s behind a load balancer. There’s no way to get into the load balancer and run the request from there, so the solution is to <code class=\"language-text\">docker exec -it {id} bash</code> into the container and create a domain proof-of-ownership file on the site.</p>\n<p>The cert I made is for a .NET core site running inside Docker on Kubernetes, with its build pipeline in Gitlab. I’m hoping to write up all my experience with Kubernetes in a blog post series soon, so it doesn’t get lost in text files.</p>\n<p>Large parts of this post are thanks to <a href=\"https://realguess.net/2016/09/26/installing-let-s-encrypt-ssl-certificate-on-google-app-engine-using-certbot/\">this blog post</a>.</p>\n<h3>Step 1. Nginx (assuming you’re using NGinx)</h3>\n<p>To verify your site (on renewal, possibly on creation too), you need a Google/Bing-style site-ownership file on your server. You will need to update your NGinx configuration to add a location for this, below is an example configuration. As this is a .NET core site, my NGinx site is actually a reverse proxy, but I’ve cut that out from the config below.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">server {\n  listen 80;\n  listen 443 ssl;\n  server_name www.example.com example.com example.local;\n  resolver 8.8.8.8;\n\n  root /usr/share/nginx/html/example.com;\n\n  ssl on;\n  ssl_protocols TLSv1 TLSv1.1 TLSv1.2;\n  ssl_prefer_server_ciphers on;\n  ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-RC4-SHA:ECDHE-RSA-AES128-SHA:AES128-SHA:RC4-SHA;\n  ssl_session_cache shared:SSL:10m;\n\n  ssl_certificate /usr/share/nginx/keys/example.com/cert.pem;\n  ssl_certificate_key /usr/share/nginx/keys/example.com/privatekey.pem;\n\n  # Lets encrypt renew domain verification files\n  location ^~ /.well-known/acme-challenge {\n    allow all;\n    default_type &quot;text/plain&quot;;\n  }\n\n}</code></pre></div>\n<h3>Step 2. Download certbot</h3>\n<p>You’ll need to follow the advanced instructions for installing certbot. This is bash for windows:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">sudo -i\ncd ~\nwget https://dl.eff.org/certbot-auto\nchmod a+x certbot-auto</code></pre></div>\n<h3>Step 3. The “fun” starts - run certbot.</h3>\n<p>The certbot command and arguments you’ll need to run:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">./certbot-auto certonly --manual --manual-public-ip-logging-ok -d example.com -d www.example.com</code></pre></div>\n<p>Follow the onscreen instructions, it’ll give you a python script with an ID piping to another ID file for each domain. <strong>DON’T PRESS RETURN YET</strong>.</p>\n<blockquote>\n<p>e.g. {FIRST-ID} > .well-known/acme-challenge/{SECOND-ID}</p>\n</blockquote>\n<h3>Step 4. In a new terminal, SSH into your Docker host</h3>\n<p>You can do this through the browser SSH client with Google Cloud.</p>\n<h3>Step 5. Find your NGinx Docker container and go inside it.</h3>\n<p>Once again this assumes you’re using NGinx.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">docker ps -a\ndocker exec -it {id} bash\ncd /usr/share/nginx/html/example.com/.well-known/acme-challenge</code></pre></div>\n<p>For every ID you were given by certbot before, echo out the id to a file:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">echo FIRST_VERYLONG_ID &gt; ANOTHER_VERY_LONG_ID</code></pre></div>\n<h3>Step 6. Hit enter on the Certbot</h3>\n<p>It’ll try a HTTP request for <a href=\"http://www.example.com/.well-known/acme-challenge/%7BANOTHER_VERY_LONG_ID%7D\">http://www.example.com/.well-known/acme-challenge/{ANOTHER<em>VERY</em>LONG_ID}</a> and expect “{FIRST<em>VERYLONG</em>ID}” back. If all goes well, it will generate the certs for you.</p>\n<h3>Step 7. (Bash for Windows only). Copy the PEM files onto the C:\\ drive</h3>\n<p>The PEM files are created in <code class=\"language-text\">/etc/letsencrypt/live/example.com</code>. You need the private and public key.</p>\n<p>On bash for windows it’s easier to just copy these to C: than finding /etc/ on the Windows file system.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">cd /etc/letsencrypt/live/example.com\nmore cert.pem &gt; /mnt/c/cert.pem\nmore privkey.pem &gt; /mnt/c/privkey.pem</code></pre></div>\n<h3>Step 8. Update the PEM files inside your NGinx Docker image</h3>\n<p>You’ll need both the private key and the cert (Letsencrypt generates a new private key for you each time).</p>\n<h3>Step 9. Docker build and launch a new Docker container.</h3>\n<p>In the pipeline I’ve created, this is as simple as pushing to Gitlab, and then updating the Docker image id using <code class=\"language-text\">kubectl edit deployments/nginx</code>. #smug-developer :D.</p>","frontmatter":{"title":"Using letsencrypt and certbot inside a Docker cluster","date":"November 16, 2016","description":"Letsencrypt.org is a free SSL certificate service. This post explains creating and renewing using its certbot for Docker containers."}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/2016-11-16-using-letsencrypt-inside-docker-clusters-and-kubernetes/","previous":{"fields":{"slug":"/2016-10-31-first-impressions-of-docker-on-windows/"},"frontmatter":{"title":"First impressions of Docker on Windows"}},"next":{"fields":{"slug":"/2017-02-01-net-core-continous-integration-gitlab-docker-kubernetes/"},"frontmatter":{"title":".NET Core continous integration and deployment with Gitlab, Docker, Kubernetes and Google Cloud"}}}}
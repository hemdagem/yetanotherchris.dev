{"data":{"site":{"siteMetadata":{"title":"Another Chris","author":"Chris Small"}},"markdownRemark":{"id":"9e0eea80-35a6-55f8-97b6-accd8bd97772","excerpt":"Over the past few months I’ve put Roadkill on hold in my free time, to get some .NET core projects working inside Docker. They’re mostly sandbox websites for…","html":"<p>Over the past few months I’ve put Roadkill on hold in my free time, to get some .NET core projects working inside Docker. They’re mostly sandbox websites for exploring the tech stack, and are hosted privately in Gitlab. Gitlab gives you a decent CI server for free, which works really well with CI and deployment of .NET core apps (both websites and console apps).</p>\n<!--more-->\n<h3>How the build works</h3>\n<p>As .NET core runs in Linux, you no longer have to worry about spinning up an over-powered Windows server. What’s more you can do it all inside a Docker container. I plan to do a series of posts on my learnings with .NET core and Kubernetes, in the meantime below is the YAML build definition build I used. It does the following:</p>\n<ol>\n<li>Build and publish (publish is just creating a clean bin folder with assets) the .NET Core app in release mode</li>\n<li>Build the Docker image in the repository: <code class=\"language-text\">docker build -t gcr.io/my-kube-project/...</code></li>\n<li>The tag I use for each Docker image is the short Git commit ID.</li>\n<li>Finally push to the Google Cloud Docker registry.</li>\n</ol>\n<p>One final step you could easily add is performing a <code class=\"language-text\">kubectl edit deployments/...</code> to update the Docker image to the latest tag, but it’s not in the YAML build definition file.</p>\n<h3>What does the app do?</h3>\n<p>The app has a website, and then a Google Cloud Pub/Sub part that is used for updating data that the website uses periodically. The Pub/Sub part is a publisher and a poller-based subscriber. I tried using push but Google Cloud had a habit of denial of servicing my endpoint, even with throttling enabled inside Nginx.</p>\n<p>All three bits are Docker containers running as seperate pods inside a Kubernetes cluster.</p>\n<h3>How can I change the file so it works with Bitbucket Pipelines/Travis/Appveyor/CI-service XYZ</h3>\n<p>You could convert it really easily to another build service YAML format. Appveyor wouldn’t make much sense, but other services would be trivial to do.</p>\n<h3>Source</h3>\n<p><div id=\"gist44399314\" class=\"gist\">\n    <div class=\"gist-file\">\n      <div class=\"gist-data\">\n        <div class=\"js-gist-file-update-container js-task-list-container file-box\">\n  <div id=\"file-gitlab-ci-yml\" class=\"file\">\n    \n\n  <div itemprop=\"text\" class=\"Box-body p-0 blob-wrapper data type-yaml \">\n      \n<table class=\"highlight tab-size js-file-line-container\" data-tab-size=\"8\">\n      <tr>\n        <td id=\"file-gitlab-ci-yml-L1\" class=\"blob-num js-line-number\" data-line-number=\"1\"></td>\n        <td id=\"file-gitlab-ci-yml-LC1\" class=\"blob-code blob-code-inner js-file-line\"><span class=\"pl-c\"><span class=\"pl-c\">#</span> http://docs.gitlab.com/ce/ci/docker/using_docker_build.html#using-the-gitlab-container-registry</span></td>\n      </tr>\n      <tr>\n        <td id=\"file-gitlab-ci-yml-L2\" class=\"blob-num js-line-number\" data-line-number=\"2\"></td>\n        <td id=\"file-gitlab-ci-yml-LC2\" class=\"blob-code blob-code-inner js-file-line\"><span class=\"pl-c\"><span class=\"pl-c\">#</span> The docker tag is the first 6 letters of the Git commit id</span></td>\n      </tr>\n      <tr>\n        <td id=\"file-gitlab-ci-yml-L3\" class=\"blob-num js-line-number\" data-line-number=\"3\"></td>\n        <td id=\"file-gitlab-ci-yml-LC3\" class=\"blob-code blob-code-inner js-file-line\">\n</td>\n      </tr>\n      <tr>\n        <td id=\"file-gitlab-ci-yml-L4\" class=\"blob-num js-line-number\" data-line-number=\"4\"></td>\n        <td id=\"file-gitlab-ci-yml-LC4\" class=\"blob-code blob-code-inner js-file-line\"><span class=\"pl-ent\">job_build_dotnet</span>:</td>\n      </tr>\n      <tr>\n        <td id=\"file-gitlab-ci-yml-L5\" class=\"blob-num js-line-number\" data-line-number=\"5\"></td>\n        <td id=\"file-gitlab-ci-yml-LC5\" class=\"blob-code blob-code-inner js-file-line\">       <span class=\"pl-ent\">stage</span>: <span class=\"pl-s\">build</span></td>\n      </tr>\n      <tr>\n        <td id=\"file-gitlab-ci-yml-L6\" class=\"blob-num js-line-number\" data-line-number=\"6\"></td>\n        <td id=\"file-gitlab-ci-yml-LC6\" class=\"blob-code blob-code-inner js-file-line\">       <span class=\"pl-ent\">image</span>: <span class=\"pl-s\">microsoft/dotnet:latest</span></td>\n      </tr>\n      <tr>\n        <td id=\"file-gitlab-ci-yml-L7\" class=\"blob-num js-line-number\" data-line-number=\"7\"></td>\n        <td id=\"file-gitlab-ci-yml-LC7\" class=\"blob-code blob-code-inner js-file-line\">       <span class=\"pl-ent\">script</span>:</td>\n      </tr>\n      <tr>\n        <td id=\"file-gitlab-ci-yml-L8\" class=\"blob-num js-line-number\" data-line-number=\"8\"></td>\n        <td id=\"file-gitlab-ci-yml-LC8\" class=\"blob-code blob-code-inner js-file-line\">         - <span class=\"pl-s\">dotnet restore</span></td>\n      </tr>\n      <tr>\n        <td id=\"file-gitlab-ci-yml-L9\" class=\"blob-num js-line-number\" data-line-number=\"9\"></td>\n        <td id=\"file-gitlab-ci-yml-LC9\" class=\"blob-code blob-code-inner js-file-line\">         - <span class=\"pl-s\">dotnet publish src/MyProject.Web -c Release</span></td>\n      </tr>\n      <tr>\n        <td id=\"file-gitlab-ci-yml-L10\" class=\"blob-num js-line-number\" data-line-number=\"10\"></td>\n        <td id=\"file-gitlab-ci-yml-LC10\" class=\"blob-code blob-code-inner js-file-line\">       <span class=\"pl-ent\">artifacts</span>:</td>\n      </tr>\n      <tr>\n        <td id=\"file-gitlab-ci-yml-L11\" class=\"blob-num js-line-number\" data-line-number=\"11\"></td>\n        <td id=\"file-gitlab-ci-yml-LC11\" class=\"blob-code blob-code-inner js-file-line\">         <span class=\"pl-ent\">expire_in</span>: <span class=\"pl-s\">12 hrs</span></td>\n      </tr>\n      <tr>\n        <td id=\"file-gitlab-ci-yml-L12\" class=\"blob-num js-line-number\" data-line-number=\"12\"></td>\n        <td id=\"file-gitlab-ci-yml-LC12\" class=\"blob-code blob-code-inner js-file-line\">         <span class=\"pl-ent\">paths</span>:</td>\n      </tr>\n      <tr>\n        <td id=\"file-gitlab-ci-yml-L13\" class=\"blob-num js-line-number\" data-line-number=\"13\"></td>\n        <td id=\"file-gitlab-ci-yml-LC13\" class=\"blob-code blob-code-inner js-file-line\">          - <span class=\"pl-s\">src/MyProject.Web/bin/Release/netcoreapp1.1/publish/</span></td>\n      </tr>\n      <tr>\n        <td id=\"file-gitlab-ci-yml-L14\" class=\"blob-num js-line-number\" data-line-number=\"14\"></td>\n        <td id=\"file-gitlab-ci-yml-LC14\" class=\"blob-code blob-code-inner js-file-line\">        </td>\n      </tr>\n      <tr>\n        <td id=\"file-gitlab-ci-yml-L15\" class=\"blob-num js-line-number\" data-line-number=\"15\"></td>\n        <td id=\"file-gitlab-ci-yml-LC15\" class=\"blob-code blob-code-inner js-file-line\"><span class=\"pl-ent\">job_build_docker</span>:</td>\n      </tr>\n      <tr>\n        <td id=\"file-gitlab-ci-yml-L16\" class=\"blob-num js-line-number\" data-line-number=\"16\"></td>\n        <td id=\"file-gitlab-ci-yml-LC16\" class=\"blob-code blob-code-inner js-file-line\">       <span class=\"pl-ent\">stage</span>: <span class=\"pl-s\">deploy</span></td>\n      </tr>\n      <tr>\n        <td id=\"file-gitlab-ci-yml-L17\" class=\"blob-num js-line-number\" data-line-number=\"17\"></td>\n        <td id=\"file-gitlab-ci-yml-LC17\" class=\"blob-code blob-code-inner js-file-line\">       <span class=\"pl-ent\">image</span>: <span class=\"pl-s\">docker:latest</span></td>\n      </tr>\n      <tr>\n        <td id=\"file-gitlab-ci-yml-L18\" class=\"blob-num js-line-number\" data-line-number=\"18\"></td>\n        <td id=\"file-gitlab-ci-yml-LC18\" class=\"blob-code blob-code-inner js-file-line\">       <span class=\"pl-ent\">services</span>:</td>\n      </tr>\n      <tr>\n        <td id=\"file-gitlab-ci-yml-L19\" class=\"blob-num js-line-number\" data-line-number=\"19\"></td>\n        <td id=\"file-gitlab-ci-yml-LC19\" class=\"blob-code blob-code-inner js-file-line\">        - <span class=\"pl-s\">docker:dind</span></td>\n      </tr>\n      <tr>\n        <td id=\"file-gitlab-ci-yml-L20\" class=\"blob-num js-line-number\" data-line-number=\"20\"></td>\n        <td id=\"file-gitlab-ci-yml-LC20\" class=\"blob-code blob-code-inner js-file-line\">       <span class=\"pl-ent\">script</span>:</td>\n      </tr>\n      <tr>\n        <td id=\"file-gitlab-ci-yml-L21\" class=\"blob-num js-line-number\" data-line-number=\"21\"></td>\n        <td id=\"file-gitlab-ci-yml-LC21\" class=\"blob-code blob-code-inner js-file-line\">        - <span class=\"pl-s\">export DOCKER_VERSION=$(echo &quot;$CI_BUILD_REF&quot; | cut -c 1-6)</span></td>\n      </tr>\n      <tr>\n        <td id=\"file-gitlab-ci-yml-L22\" class=\"blob-num js-line-number\" data-line-number=\"22\"></td>\n        <td id=\"file-gitlab-ci-yml-LC22\" class=\"blob-code blob-code-inner js-file-line\">        - <span class=\"pl-s\">echo &quot;$GOOGLE_AUTH_JSON&quot; &gt; google-cloud.json</span></td>\n      </tr>\n      <tr>\n        <td id=\"file-gitlab-ci-yml-L23\" class=\"blob-num js-line-number\" data-line-number=\"23\"></td>\n        <td id=\"file-gitlab-ci-yml-LC23\" class=\"blob-code blob-code-inner js-file-line\">        - <span class=\"pl-s\">cd src/MyProject.Web &amp;&amp; docker build -t gcr.io/my-kube-project/MyProject-web:$DOCKER_VERSION .</span></td>\n      </tr>\n      <tr>\n        <td id=\"file-gitlab-ci-yml-L24\" class=\"blob-num js-line-number\" data-line-number=\"24\"></td>\n        <td id=\"file-gitlab-ci-yml-LC24\" class=\"blob-code blob-code-inner js-file-line\">        - <span class=\"pl-s\">cd ../../ &amp;&amp; docker login -e 1234@5678.com -u _json_key -p &quot;$(cat google-cloud.json)&quot; https://gcr.io</span></td>\n      </tr>\n      <tr>\n        <td id=\"file-gitlab-ci-yml-L25\" class=\"blob-num js-line-number\" data-line-number=\"25\"></td>\n        <td id=\"file-gitlab-ci-yml-LC25\" class=\"blob-code blob-code-inner js-file-line\">        - <span class=\"pl-s\">docker push gcr.io/my-kube-project/MyProject-web:$DOCKER_VERSION</span></td>\n      </tr>\n      <tr>\n        <td id=\"file-gitlab-ci-yml-L26\" class=\"blob-num js-line-number\" data-line-number=\"26\"></td>\n        <td id=\"file-gitlab-ci-yml-LC26\" class=\"blob-code blob-code-inner js-file-line\">       <span class=\"pl-ent\">dependencies</span>:</td>\n      </tr>\n      <tr>\n        <td id=\"file-gitlab-ci-yml-L27\" class=\"blob-num js-line-number\" data-line-number=\"27\"></td>\n        <td id=\"file-gitlab-ci-yml-LC27\" class=\"blob-code blob-code-inner js-file-line\">        - <span class=\"pl-s\">job_build_dotnet</span></td>\n      </tr>\n</table>\n\n\n  </div>\n\n  </div>\n</div>\n\n      </div>\n      <div class=\"gist-meta\">\n        <a href=\"https://gist.github.com/yetanotherchris/7be82856f3240776a880d3bf540bf844/raw/5bc5ca861641c77536b4084b3397642ef75bb400/%20.gitlab-ci.yml\" style=\"float:right\">view raw</a>\n        <a href=\"https://gist.github.com/yetanotherchris/7be82856f3240776a880d3bf540bf844#file-gitlab-ci-yml\"> .gitlab-ci.yml</a>\n        hosted with &#10084; by <a href=\"https://github.com\">GitHub</a>\n      </div>\n    </div>\n</div></p>","frontmatter":{"title":".NET Core continous integration and deployment with Gitlab, Docker, Kubernetes and Google Cloud","date":"February 01, 2017","description":null}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/2017-02-01-net-core-continous-integration-gitlab-docker-kubernetes/","previous":{"fields":{"slug":"/2016-11-16-using-letsencrypt-inside-docker-clusters-and-kubernetes/"},"frontmatter":{"title":"Using letsencrypt and certbot inside a Docker cluster"}},"next":{"fields":{"slug":"/2017-02-23-change-your-powershell-prompt-to-look-like-bash/"},"frontmatter":{"title":"Change your Powershell prompt to look like bash"}}}}
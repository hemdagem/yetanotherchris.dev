{"data":{"site":{"siteMetadata":{"title":"Another Chris","author":"Chris Small"}},"markdownRemark":{"id":"0df24997-c0a9-5c59-969f-296981af52dd","excerpt":"A while ago Roadkill’s CI solution was hosted on Appharbor, which was a great solution (and free for a single project), but the configuration hacking and I…","html":"<p>A while ago Roadkill’s CI solution was hosted on Appharbor, which was a great solution (and free for a single project), but the configuration hacking and I problems with the hosted environment with the unit tests meant it wasn’t a viable solution for Roadkill’s requirements.</p>\n<p>After Appharbor I moved onto using Bamboo from Atlassian. This, like Appharbor, was also a great hosted product but was costing me a lot in Amazon EC2 hosting costs which I was too cheap and miserly to pay for.</p>\n<p>I then moved onto Teamcity which is the CI I’m most familiar with, having set it up and used in two companies over the past 5 years. Right now, the Teamcity mothership is hosted on DigitalOcean and a Teamcity agent runs on my desktop PC to run the build. I’m also too cheap with this solution to keep it running 24/7, so I launch it on demand which is really when I do check-ins to Roadkill.</p>\n<p>A few days ago I heard about <a href=\"http://www.appveyor.com\">Appveyor</a> through the grapevine and decided to give it a try with Roadkill. Appveyor does all its instancing via Azure, but also lets you control the instance using post-install and post-build powershell hooks rather than the completely sandboxed approach of Appharbor.</p>\n<p>So far I’ve been impressed at how easy it is to use, but also how customisable your instances can be.</p>\n<p>With a post-install hook I installed Chocolatey and then Chrome and MongoDB (with SQL Express 2012 already installed):</p>\n<p><div id=\"gist12354840\" class=\"gist\">\n    <div class=\"gist-file\">\n      <div class=\"gist-data\">\n        <div class=\"js-gist-file-update-container js-task-list-container file-box\">\n  <div id=\"file-appveyorchrome-ps1\" class=\"file\">\n    \n\n  <div itemprop=\"text\" class=\"Box-body p-0 blob-wrapper data type-powershell \">\n      \n<table class=\"highlight tab-size js-file-line-container\" data-tab-size=\"8\">\n      <tr>\n        <td id=\"file-appveyorchrome-ps1-L1\" class=\"blob-num js-line-number\" data-line-number=\"1\"></td>\n        <td id=\"file-appveyorchrome-ps1-LC1\" class=\"blob-code blob-code-inner js-file-line\"><span class=\"pl-c\"><span class=\"pl-c\">#</span> Project-&gt;Settings-&gt;Environment-&gt;Install script<span class=\"pl-c\"></span></span></td>\n      </tr>\n      <tr>\n        <td id=\"file-appveyorchrome-ps1-L2\" class=\"blob-num js-line-number\" data-line-number=\"2\"></td>\n        <td id=\"file-appveyorchrome-ps1-LC2\" class=\"blob-code blob-code-inner js-file-line\">iex ((<span class=\"pl-c1\">new-object</span> net.webclient).DownloadString(<span class=\"pl-s\"><span class=\"pl-pds\">&#39;</span>https://chocolatey.org/install.ps1<span class=\"pl-pds\">&#39;</span></span>))</td>\n      </tr>\n      <tr>\n        <td id=\"file-appveyorchrome-ps1-L3\" class=\"blob-num js-line-number\" data-line-number=\"3\"></td>\n        <td id=\"file-appveyorchrome-ps1-LC3\" class=\"blob-code blob-code-inner js-file-line\">\n</td>\n      </tr>\n      <tr>\n        <td id=\"file-appveyorchrome-ps1-L4\" class=\"blob-num js-line-number\" data-line-number=\"4\"></td>\n        <td id=\"file-appveyorchrome-ps1-LC4\" class=\"blob-code blob-code-inner js-file-line\">cinst GoogleChrome</td>\n      </tr>\n      <tr>\n        <td id=\"file-appveyorchrome-ps1-L5\" class=\"blob-num js-line-number\" data-line-number=\"5\"></td>\n        <td id=\"file-appveyorchrome-ps1-LC5\" class=\"blob-code blob-code-inner js-file-line\">cinst gb.MongoDB</td>\n      </tr>\n</table>\n\n\n  </div>\n\n  </div>\n</div>\n\n      </div>\n      <div class=\"gist-meta\">\n        <a href=\"https://gist.github.com/yetanotherchris/0f1d763e6d539fc61857/raw/77dcdcc87aa8207d032e8ec75a17fe3b7c55234c/AppveyorChrome.ps1\" style=\"float:right\">view raw</a>\n        <a href=\"https://gist.github.com/yetanotherchris/0f1d763e6d539fc61857#file-appveyorchrome-ps1\">AppveyorChrome.ps1</a>\n        hosted with &#10084; by <a href=\"https://github.com\">GitHub</a>\n      </div>\n    </div>\n</div></p>\n<!--more-->\n<p>After this, I had to do a bit of hackery to change the configuration file connection strings, as they default to using (local) for the instance and integrated security. The best tool for hacky ugly code is of course Powershell:</p>\n<p><div id=\"gist12354927\" class=\"gist\">\n    <div class=\"gist-file\">\n      <div class=\"gist-data\">\n        <div class=\"js-gist-file-update-container js-task-list-container file-box\">\n  <div id=\"file-appveyorconfigfile-ps1\" class=\"file\">\n    \n\n  <div itemprop=\"text\" class=\"Box-body p-0 blob-wrapper data type-powershell \">\n      \n<table class=\"highlight tab-size js-file-line-container\" data-tab-size=\"8\">\n      <tr>\n        <td id=\"file-appveyorconfigfile-ps1-L1\" class=\"blob-num js-line-number\" data-line-number=\"1\"></td>\n        <td id=\"file-appveyorconfigfile-ps1-LC1\" class=\"blob-code blob-code-inner js-file-line\"><span class=\"pl-c\"><span class=\"pl-c\">#</span> Project-&gt;Settings-&gt;Build-&gt;Before build script<span class=\"pl-c\"></span></span></td>\n      </tr>\n      <tr>\n        <td id=\"file-appveyorconfigfile-ps1-L2\" class=\"blob-num js-line-number\" data-line-number=\"2\"></td>\n        <td id=\"file-appveyorconfigfile-ps1-LC2\" class=\"blob-code blob-code-inner js-file-line\">(gc lib\\Configs\\connectionStrings.dev.config).replace(<span class=\"pl-s\"><span class=\"pl-pds\">&#39;</span>Server=(local);Integrated Security=true;Connect Timeout=5;database=Roadkill<span class=\"pl-pds\">&#39;</span></span><span class=\"pl-k\">,</span><span class=\"pl-s\"><span class=\"pl-pds\">&#39;</span>Server=(local)\\SQL2012SP1;Database=master;User ID=sa;Password=Password12!<span class=\"pl-pds\">&#39;</span></span>) <span class=\"pl-k\">|</span> <span class=\"pl-c1\">Out-File</span> lib\\Configs\\connectionStrings.dev.config</td>\n      </tr>\n      <tr>\n        <td id=\"file-appveyorconfigfile-ps1-L3\" class=\"blob-num js-line-number\" data-line-number=\"3\"></td>\n        <td id=\"file-appveyorconfigfile-ps1-LC3\" class=\"blob-code blob-code-inner js-file-line\">\n</td>\n      </tr>\n      <tr>\n        <td id=\"file-appveyorconfigfile-ps1-L4\" class=\"blob-num js-line-number\" data-line-number=\"4\"></td>\n        <td id=\"file-appveyorconfigfile-ps1-LC4\" class=\"blob-code blob-code-inner js-file-line\">(gc src\\Roadkill.Tests\\Setup\\SqlExpressSetup.cs).replace(<span class=\"pl-s\"><span class=\"pl-pds\">&#39;</span>Server=(local);Integrated Security=true;Connect Timeout=5;database=Roadkill<span class=\"pl-pds\">&#39;</span></span><span class=\"pl-k\">,</span><span class=\"pl-s\"><span class=\"pl-pds\">&#39;</span>Server=(local)\\SQL2012SP1;Database=master;User ID=sa;Password=Password12!<span class=\"pl-pds\">&#39;</span></span>) <span class=\"pl-k\">|</span> <span class=\"pl-c1\">Out-File</span> src\\Roadkill.Tests\\Setup\\SqlExpressSetup.cs</td>\n      </tr>\n</table>\n\n\n  </div>\n\n  </div>\n</div>\n\n      </div>\n      <div class=\"gist-meta\">\n        <a href=\"https://gist.github.com/yetanotherchris/741b3ca836e505d04c59/raw/20fdf9fdcda89e188d7cdc66b1945230a454a9e1/AppveyorConfigFile.ps1\" style=\"float:right\">view raw</a>\n        <a href=\"https://gist.github.com/yetanotherchris/741b3ca836e505d04c59#file-appveyorconfigfile-ps1\">AppveyorConfigFile.ps1</a>\n        hosted with &#10084; by <a href=\"https://github.com\">GitHub</a>\n      </div>\n    </div>\n</div></p>\n<p>“gc” is a shortcut for get-content, and the “output-file” cmdlet is important as the text file isn’t saved without it.</p>\n<p>With these scripts in place, there is a small tweak you should make to the Git settings (Appveyor is free for public Github and Bitbucket projects) - make sure the clone depth is 1 to avoid the entire history of a project being downloaded. That’s important for Roadkill, as I store the Nuget packages folder in the repository so I can work offline on my laptop easily.</p>\n<p>Everything works well and it is really fast to get going. The main setbacks I’ve had, which are Roadkill related, are the size of the Roadkill Git repository is huge (around 200mb), and Chrome/MongoDB is also a lengthy install. So the builds go from around 15 minutes locally to 30 minutes on Appveyor.</p>\n<p>The acceptance tests ran via Chrome, against the local IIS Express server, however they conk out after 30 tests which I’m assuming is from the instance running out of memory or having a maxed out CPU. Integration and Unit tests both ran fine however, with the main set back being the launch time. But I don’t mind too much about that, and I can live without the acceptance tests being run via the CI for now, happy to “decomission” the Teamcity in the coming weeks.</p>","frontmatter":{"title":"Using Appveyor as Roadkill's CI to run acceptance tests","date":"June 11, 2014","description":null}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/2014-06-11-using-appveyor-as-roadkills-ci-to-run-acceptance-tests/","previous":{"fields":{"slug":"/2014-05-21-a-c-uk-bank-holiday-calculator/"},"frontmatter":{"title":"A C# UK bank holiday calculator"}},"next":{"fields":{"slug":"/2014-08-08-net-logging-libraries-compared/"},"frontmatter":{"title":".NET logging libraries compared"}}}}